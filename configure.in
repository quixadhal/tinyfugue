dnl
dnl  TinyFugue - programmable mud client
dnl  Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2002, 2003 Ken Keys
dnl
dnl  TinyFugue (aka "tf") is protected under the terms of the GNU
dnl  General Public License.  See the file "COPYING" for details.
dnl
dnl  DO NOT EDIT THIS FILE.
dnl  Any configuration changes should be made to the unix/Config file.
dnl

AC_REVISION($Id: configure.in,v 35000.30 2003/05/28 06:58:13 hawkeye Exp $)

dnl Note: autoconf uses <<EOF, so we use <<END instead.

dnl ### Initialize variables.

SOCKS=''
OTHER_OBJS=""

prefix_default() {
    if test -w /usr/local/bin && test -w /usr/local/lib; then
	echo "/usr/local"
    elif test `uname -s` = 'BeOS'; then
	# prefix according to Steven Black <steven@be.com>
	echo "$HOME/config"
    else
	echo "$HOME"
    fi
}

enable_inet6=no
enable_netdb=yes
enable_termcap=default
terminal_hardcode="TERM_vt100";
enable_version=no
enable_symlink=default
enable_mailcheck=yes
enable_manpage=no
enable_history=yes
enable_process=yes
enable_float=yes
enable_strip=no

enable_development=default
enable_dmalloc=no


dnl ### Initialize autoconf.

AC_INIT(src/tf.h)

AC_CONFIG_HEADER(src/config.h)

AC_PREFIX_DEFAULT(`prefix_default`)

TFVER=`sed -ne 's/^TFVER=\(.*\)/\1/p' src/vars.mak`
TFVERSION=`sed -n -e '/Fugue version/s/^.*"\(.*\)".*$/\1/p' src/main.c`
AC_SUBST(TFVERSION)
AC_MSG_RESULT([Configuring $TFVERSION])

# User installation options
AC_ARG_ENABLE(version, [  --enable-version        insert version number into name of tf executable
                          and library directory (implies --enable-symlink)])
AC_ARG_ENABLE(symlink, [  --enable-symlink[=NAME] make a symlink NAME to the executable [PREFIX/bin/tf]])

AC_ARG_ENABLE(inet6,   [  --enable-inet6          enable IPv6 support])
AC_ARG_ENABLE(netdb,   [  --disable-netdb         disable hostname resolution])
AC_ARG_ENABLE(termcap, [  --disable-termcap       use hardcoded vt100 codes instead of termcap])
AC_ARG_ENABLE(termcap, [  --enable-termcap=LIB    enable termcap with library LIB (e.g., "ncurses")
                          (needed only if configure guesses incorrectly)])
AC_ARG_ENABLE(mail,    [  --disable-mailcheck     disable mail checking])
AC_ARG_ENABLE(mail,    [  --enable-mailcheck=DIR  enable checking for mail in directory DIR
                          (needed only if configure guesses incorrectly)])
AC_ARG_ENABLE(manpage, [  --enable-manpage        enable installation of man page])
AC_ARG_ENABLE(strip,   [  --enable-strip          strip debugging symbols from executable])

# User feature options
AC_ARG_ENABLE(history, [  --disable-history       disable /recall and other history features])
AC_ARG_ENABLE(process, [  --disable-process       disable /quote and /repeat])
AC_ARG_ENABLE(float,   [  --disable-float         disable floating point arithmetic and functions])

AC_ARG_WITH(incdirs,
    [  --with-incdirs=DIRS       search for include files in DIRS])
AC_ARG_WITH(libdirs,
    [  --with-libdirs=DIRS       search for libraries in DIRS])
AC_ARG_WITH(inclibdirs,
    [  --with-inclibdirs=DIRS    same as --with-incdirs=DIRS --with-libdirs=DIRS])
AC_ARG_WITH(inclibprefix,
    [  --with-inclibprefix=DIRS  same, but appends '/include' and '/lib'])
AC_ARG_WITH(incdir) dnl because I never remember if it's singular or plural
AC_ARG_WITH(libdir) dnl because I never remember if it's singular or plural
AC_ARG_WITH(inclibdir) dnl because I never remember if it's singular or plural


if test "$enable_strip"   = "no"; then STRIP=":";             fi

# Developer options
AC_ARG_ENABLE(development)
AC_ARG_ENABLE(dmalloc)

if test "$enable_development" = "default"; then
    if test -d CVS; then
	enable_development=yes
	AC_MSG_RESULT([Development version.])
    else
	enable_development=no
    fi
fi
AC_MSG_RESULT([])

if test "$enable_development" = "yes"; then
    if test "$enable_symlink" = "default"; then
	enable_symlink=no
    fi
    if test -z "${CC}"; then
	AC_CHECK_PROGS(CC, tfcc gcc-anal)
    fi
    if test -z "${CFLAGS}"; then
	CFLAGS="-g"
    fi
    enable_version="yes"
    STRIP=":"
else
    AC_DEFINE(NDEBUG)
fi

dnl XXX option: TTYDRIVER


if test "$enable_development" = "no" &&
    echo $TFVERSION | egrep "alpha" >/dev/null 2>&1; then
cat <<END
This is an alpha version, and so may not be fully tested on some platforms.
With the new features comes the possibility of new bugs.  If you don't want
to deal with this, get the latest stable or gamma version.

END
fi

UNAME=`{ uname -s && uname -v && uname -r || uname -a; } 2>/dev/null`
UNAME=`echo $UNAME`  # remove newlines
AC_SUBST(UNAME)
AC_CYGWIN

dnl ########### programs ############

AC_PROG_CC
AC_PROG_GCC_TRADITIONAL
dnl XXX STD_C=1, if compiler is standard

dnl XXX
dnl ${CC} ${CCFLAGS} -c symtest.c >symtest.out 2>&1 || {
dnl     echo
dnl     cat symtest.out
dnl     echo
dnl     echo "## The messages above indicate one of these configuration problems:"
dnl     echo "##   1. the compiler is not installed correctly;"
dnl     echo "##   2. you do not have permission to execute the compiler; or"
dnl     echo "##   3. CCFLAGS='${CCFLAGS}' in unix/Config is invalid."
dnl     echo "## In any case, this is a local problem that can only be"
dnl     echo "## solved by you or a system administrator, so don't ask me."
dnl     echo
dnl     exit 1
dnl }

dnl XXX AC_AIX

AC_PROG_MAKE_SET

AC_CHECK_PROG(STRIP, strip, strip, :)
AC_CHECK_PROG(RANLIB, ranlib, ranlib, :)


dnl ########### libraries ############

dnl ### Library testing.
dnl # If libfoo.a make references to libbar.a, the order must be "-lfoo -lbar".
dnl # So we test incrementally, building the list from right to left.
dnl # Dynix/ptx needs: -lsocket -linet -lnsl
dnl # SysV needs: -lsocket -lnsl


dnl TF_DIRS(src, dst[, prefix[, suffix]])
AC_DEFUN(TF_DIRS, [
    if test "${$1}" != "no" && test "${$1}" != ""; then
        for dir in ${$1}; do
            $2="${$2} $3${dir}$4"
        done
    fi
])

TF_DIRS(with_incdirs, CPPFLAGS, -I)
TF_DIRS(with_incdir, CPPFLAGS, -I)
TF_DIRS(with_inclibdirs, CPPFLAGS, -I)
TF_DIRS(with_inclibdir, CPPFLAGS, -I)
TF_DIRS(with_inclibprefix, CPPFLAGS, -I, /include)

LIBDIRS=""
TF_DIRS(with_libdirs, LIBDIRS, -L)
TF_DIRS(with_libdir, LIBDIRS, -L)
TF_DIRS(with_inclibdirs, LIBDIRS, -L)
TF_DIRS(with_inclibdir, LIBDIRS, -L)
TF_DIRS(with_inclibprefix, LIBDIRS, -L, /lib)

dnl Must append LIBDIRS to CFLAGS now so it's present for AC_CHECK_LIB.
dnl (LIBDIRS will not work in the OTHER-LIBRARIES argument of AC_CHECK_LIB
dnl on all platforms since it will _follow_ the -l option for the library
dnl being tested.)
CFLAGS="$CFLAGS $LIBDIRS"


AC_SEARCH_LIBS(select, bsd, ,
    AC_MSG_ERROR([TF can not work without select().]))

dnl # gethostbyname may not be in default libraries.
dnl # QNX keeps gethostbyname in lsocket.
AC_SEARCH_LIBS(gethostbyname, bsd nsl_s nsl resolv socket, ,
    AC_MSG_WARN([Host name resolution will not be available.]))

dnl ### If -linet exists, assume we need it.
AC_CHECK_LIB(inet, main)

dnl ### If -lnet exists, assume we need it.
AC_CHECK_LIB(net, main)

dnl ## If we haven't found connect(), look for -lsocket.
dnl ## Note: on IRIX 5, -lsocket exists, but we mustn't use its gethostbyname().
AC_SEARCH_LIBS(connect, socket)


dnl XXX --enable-socks
dnl if test "$enable_socks" != "no" ; then
dnl     # SOCKS uses res_init(), so we need -lresolv if there is one.
dnl     AC_SEARCH_LIBS(res_init, resolv)
dnl     AC_SEARCH_LIBS(XXX, socks5 "-lsocks5 -L/usr/local/lib" \
dnl 	socks "-lsocks -L/usr/local/lib")
dnl     AC_CHECK_HEADERS(socks.h) dnl -I/usr/local/include
dnl     echo "#define SOCKS ${SOCKS}" >&4
dnl     if test -n "$SOCKS_NONBLOCK" ; then
dnl         echo "#define SOCKS_NONBLOCK" >&4
dnl     fi
dnl fi


dnl ### I'm guessing setlocale() is in libintl on some systems, if not in libc.
AC_SEARCH_LIBS(setlocale, intl, ,
    AC_MSG_WARN([Locales will not be supported.]))

dnl ### OpenSSL
AC_CHECK_LIB(crypto, main)
AC_CHECK_LIB(ssl, SSL_new)

dnl ### test termcap.
dnl # At least one system (Red Hat Linux) has a broken ncurses and a working
dnl # termcap, so we try termcap before ncurses.

dnl # Cygwin may not have termcap at all, but it only supports ANSI emulation
dnl # anyway, so we hardcode that (unless it was overridden).
if test "$CYGWIN" = "yes"; then
    terminal_hardcode="TERM_ansi";
    if test "$enable_termcap" = "default"; then
	enable_termcap="no";
    fi
fi

if test "$enable_termcap" = "default"; then
    enable_termcap="yes";
fi

if test "$enable_termcap" = "no"; then
    AC_DEFINE_UNQUOTED(HARDCODE, $terminal_hardcode)
else
    if test "$enable_termcap" = "yes"; then enable_termcap=""; fi
    AC_SEARCH_LIBS(tgetent, $enable_termcap termcap ncurses curses,
	AC_DEFINE(TERMCAP)
    ,
	AC_DEFINE_UNQUOTED(HARDCODE, $terminal_hardcode)
	AC_MSG_WARN([Hardcoding terminal codes.]))
fi
dnl XXX check for debian linux's broken termcap


if test "$enable_float" = "yes"; then
    AC_SEARCH_LIBS(sqrt, m)
fi

AC_CHECK_LIB(z, inflate)


dnl ########### headers ############

AC_HEADER_STDC
AC_CHECK_HEADERS(unistd.h memory.h sys/select.h)
AC_HEADER_SYS_WAIT

dnl ### For optional language support.
AC_CHECK_HEADERS(locale.h, ,
    AC_MSG_WARN([Locales will not be supported.]))

dnl ### Find pwd.h
AC_CHECK_HEADERS(pwd.h, ,
AC_MSG_WARN([Filename '~user' expansion will not be supported.]))

dnl ### Find zlib.h
AC_CHECK_HEADERS(zlib.h)


dnl TF_SEARCH_HEADERS(SYMBOL, HEADERS... [, DO-IF-FOUND [, DO-IF-NOT-FOUND]])
dnl Searches for each header in HEADERS, and defines SYMBOL to the first one
dnl found.
AC_DEFUN(TF_SEARCH_HEADERS, [
    found=0;
    for f in $2; do
	AC_CHECK_HEADERS($f,
	    AC_DEFINE_UNQUOTED($1, <$f>)
	    found=1
	    break)
	if test $found -eq 1; then break; fi
    done
    if test $found -eq 1; then
	:; $3
    else
	:; $4
    fi
    unset found
])


dnl ### Find internet structure header
TF_SEARCH_HEADERS(NETINET_IN_H, netinet/in.h sys/in.h sys/netinet/in.h, ,
AC_MSG_WARN([I will use my own internet structures.  Good luck.]))

dnl ### Find internet address header
TF_SEARCH_HEADERS(ARPA_INET_H, arpa/inet.h sys/inet.h)

dnl ### Find netdb header
if test "$enable_netdb" = "yes"; then
    TF_SEARCH_HEADERS(NETDB_H, netdb.h sys/netdb.h, ,
    AC_MSG_WARN([Hostname resolution and port names will not be available.]))
fi


dnl ### Figure out which terminal driver to use.

AC_CHECK_HEADER(termios.h, AC_DEFINE(USE_TERMIOS),
  AC_CHECK_HEADER(termio.h, AC_DEFINE(USE_TERMIO),
    AC_CHECK_HEADER(sgtty.h, AC_DEFINE(USE_SGTTY))))

dnl # Some brain damaged systems (Xenix) need <sys/ptem.h> for struct winsize.
AC_EGREP_HEADER([struct winsize], sys/ptem.h, AC_DEFINE(NEED_PTEM_H))


dnl ########### typedefs ############

dnl TF_CHECK_TYPE(TYPE, DEFAULT [, OTHER_HEADERS])
dnl ...because AC_CHECK_TYPE doesn't have OTHER_HEADERS
AC_DEFUN(TF_CHECK_TYPE,
[AC_REQUIRE([AC_HEADER_STDC])dnl
AC_MSG_CHECKING(for $1)
AC_CACHE_VAL(ac_cv_type_$1,
[AC_EGREP_CPP(dnl
changequote(<<,>>)dnl
<<(^|[^a-zA-Z_0-9])$1[^a-zA-Z_0-9]>>dnl
changequote([,]), [#include <sys/types.h>
#if STDC_HEADERS
#include <stdlib.h>
#include <stddef.h>
#endif], ac_cv_type_$1=yes, ac_cv_type_$1=no)])dnl
AC_MSG_RESULT($ac_cv_type_$1)
if test $ac_cv_type_$1 = no; then
  AC_DEFINE($1, $2)
fi
])


AC_TYPE_SIGNAL
AC_TYPE_PID_T
AC_TYPE_SIZE_T
AC_CHECK_TYPE(time_t, long)
TF_CHECK_TYPE(socklen_t, int, [#include <sys/socket.h>])


dnl ########### structures ############


dnl ########### compiler characteristics ############

AC_CHECK_SIZEOF(short)
AC_CHECK_SIZEOF(int)
AC_CHECK_SIZEOF(long)

if test "$GCC" = "yes"; then
    # gcc may generate a warning for "inline", so use "__inline__" instead.
    AC_MSG_CHECKING([for inline])
    AC_MSG_RESULT([yes])
    AC_DEFINE(inline, __inline__)
else
    AC_C_INLINE
fi


dnl ########### functions ############

dnl # SCO keeps strftime() in -lintl
AC_FUNC_STRFTIME

dnl # h_errno is a variable, not a function.  But AC_CHECK_FUNCS only checks
dnl # that the symbol is defined, so this works.
AC_CHECK_FUNCS(h_errno)

dnl # required standard functions
AC_CHECK_FUNCS(strstr strtol, ,
    AC_MSG_ERROR([Missing required standard function.]))
dnl # simple functions
AC_CHECK_FUNCS(bcopy bsearch bzero connect fileno getcwd \
    gethostbyname gethostbyname2 getipnodebyname \
    getpwnam gettimeofday getwd hstrerror index inet_aton)
AC_CHECK_FUNCS(inet_pton, , enable_inet6=no)
AC_CHECK_FUNCS(kill memcpy memset raise setlocale sigaction srand srandom \
    strcasecmp strchr strcmpi strcspn strerror stricmp strtod tzset waitpid)

dnl # override a few values
if test "$CYGWIN" = "yes"; then
    AC_DEFINE(HAVE_BSEARCH, [0  /* bsearch() is broken in cygwin32 b18. */])
    AC_DEFINE(HAVE_H_ERRNO, [0  /* h_errno is broken in cygwin32 b18. */])
fi

if test "$enable_inet6" = "yes"; then
    AC_MSG_CHECKING([for IPv6 address structure])
    for type in in6_addr in_addr6; do
	AC_TRY_COMPILE([
#include <sys/types.h>
#include <sys/socket.h>
#include NETINET_IN_H
],
	    [
#ifndef AF_INET6
# error
#endif
	    struct ${type} foo;
	    ],
	    AC_DEFINE_UNQUOTED(IN6_ADDR, $type)
	    AC_MSG_RESULT([$type])
	    break)
    done
fi


dnl ########### system services ############

dnl # These should come after AC_PROG_CC.
AC_EXEEXT
AC_OBJEXT

dnl ### Find mail directory by looking at $MAIL, then in the usual places.
if test "$enable_mailcheck" = "no"; then
    MAILDIR=""
elif test "$enable_mailcheck" = "yes"; then
    AC_MSG_CHECKING([location of mail directory])
    if test -n "$MAIL" ; then
        # Not every system has dirname.  sigh.
        changequote(, )dnl We need brackets for the regexp.
        MAILDIR=`echo $MAIL | sed 's;/[^/]*$;;'`
        changequote([, ])dnl Restore bracket quotes.
    elif test -d /usr/spool/mail ; then
        MAILDIR="/usr/spool/mail"
    elif test -d /var/spool/mail ; then
        MAILDIR="/var/spool/mail"
    elif test -d /usr/mail ; then
        MAILDIR="/usr/mail"
    elif test -d /var/mail ; then
        MAILDIR="/var/mail"
    else
	MAILDIR=""
    fi
    AC_MSG_RESULT([${MAILDIR-(none)}])
else
    MAILDIR="$enable_mailcheck"
fi
if test -n "$MAILDIR"; then
    AC_DEFINE_UNQUOTED(MAILDIR, "$MAILDIR")
fi


dnl ### Figure out names of executable, library directory, and symlink.

if test "$enable_version" = "no"; then
    LIBNAME="tf-lib"
    EXENAME="tf"
    if test "$enable_symlink" = "default"; then
	enable_symlink=no
    fi
else
    LIBNAME="tf-${TFVER}-lib"
    EXENAME="tf-${TFVER}"
    if test "$enable_symlink" = "default"; then
	enable_symlink=yes
    fi
fi

if test "$enable_symlink" = "no"; then
    SYMLINK=""
elif test "$enable_symlink" = "yes"; then
    SYMLINK='${prefix}/bin/tf'
else
    SYMLINK="$enable_symlink"
fi

AC_SUBST(EXENAME)
AC_SUBST(LIBNAME)
AC_SUBST(SYMLINK)

dnl ### man page

if test "$enable_manpage" = "yes"; then
    MANPAGE='${mandir}/man1/tf.1'
    MANTYPE='nroff'
else
    MANPAGE=''
    MANTYPE=''
fi
AC_SUBST(MANPAGE)
AC_SUBST(MANTYPE) dnl XXX


dnl ########### output ############


dnl ########### end ############


dnl # XXX
dnl ### Sanity check for filenames (some people do pretty stupid things)
dnl # The "${SYMLINK}/" is just to make the grep return false if SYMLINK is empty.
dnl #
dnl #if echo "$TF"          | egrep "^[^/]" >/dev/null 2>&1 ||
dnl #   echo "$LIBDIR"      | egrep "^[^/]" >/dev/null 2>&1 ||
dnl #   echo "${SYMLINK}/"  | egrep "^[^/]" >/dev/null 2>&1
dnl #then
dnl #   echo "Don't install files with relative paths or '~'."
dnl #   echo "Edit unix/Config and try again."
dnl #   exit 2
dnl #fi
dnl #
dnl ## Don't allow installation in the build tree (people have actually tried this).
dnl ## The cd;pwd is needed to normalize the directory name in case of links, etc.
dnl #
dnl #DIR1=`echo $TF      | sed 's;/[^/]*$;;'`
dnl #DIR1=`cd $DIR1 && pwd`
dnl #DIR2=`echo $LIBDIR  | sed 's;/[^/]*$;;'`
dnl #DIR2=`cd $DIR2 && pwd`
dnl #DIR3=`echo $SYMLINK | sed 's;/[^/]*$;;'`
dnl #DIR3=`cd $DIR3 && pwd`
dnl #
dnl #if test -z "$DIR1"  || test -z "$DIR2"  || test -z "$DIR3" ; then
dnl #    echo "Error in directory."
dnl #    exit 1;
dnl #fi
dnl #
dnl #DIR1=`cd $DIR1 && pwd || { echo "Error in directory $DIR1."; false; }`
dnl #
dnl #BUILDTREE=`cd .. && pwd`
dnl #if echo "${DIR1}/" | egrep "^${BUILDTREE}/" >/dev/null 2>&1 ||
dnl #   echo "${DIR2}/" | egrep "^${BUILDTREE}/" >/dev/null 2>&1 ||
dnl #   echo "${DIR3}/" | egrep "^${BUILDTREE}/" >/dev/null 2>&1
dnl #then
dnl #    echo
dnl #    echo 'You can not install files in the build tree,'
dnl #    echo "${BUILDTREE}."
dnl #    echo 'Edit unix/Config and try again.'
dnl #    exit 2
dnl #fi
dnl #
dnl # Too many people have renamed the distribution directory to "$HOME/tf", and
dnl # then wondered why they couldn't install the executable as "$HOME/tf".
dnl #if test -d "${TF}" ; then
dnl #    echo "\"${TF}\" is a directory; you can not install the executable"
dnl #    echo 'with the same name.  Either rename the directory, or choose a'
dnl #    echo 'different name for the executable.'
dnl #    exit 1
dnl #fi


MODE=755
AC_SUBST(MODE)




dnl ### Make sure the PATH is sane.
dnl # Ideally, this should be done before the compiler check.  But a compiler
dnl # found now in the extended PATH won't be found in src/Makefile, because it
dnl # won't inherit this PATH.
PATH="$PATH:/bin:/usr/bin:/usr/local/bin:/usr/ucb:/usr/local:/usr/lbin:/etc:/usr/new:/usr/new/bin:/usr/nbin:/usr/ccs/bin"


if test "$enable_dmalloc" = "yes"; then
    CPPFLAGS="$CPPFLAGS -DUSE_DMALLOC"
    OTHER_OBJS="$OTHER_OBJS dmalloc.o"
fi

dnl ### write variables

if test "$enable_inet6"   = "yes"; then AC_DEFINE(ENABLE_INET6)  fi
if test "$enable_history" = "no"; then AC_DEFINE(NO_HISTORY)  fi
if test "$enable_process" = "no"; then AC_DEFINE(NO_PROCESS)  fi
if test "$enable_float"   = "no"; then AC_DEFINE(NO_FLOAT)    fi

AC_SUBST(CFLAGS)
AC_SUBST(CPPFLAGS)
AC_SUBST(LIBS)
AC_SUBST(OTHER_OBJS)

AC_OUTPUT(Makefile unix/vars.mak src/tfdefs.h, [

### Create src/Makefile from pieces.

cat >src/Makefile <<END
#### DO NOT EDIT THIS FILE.
#### This src/Makefile was automatically generated by configure.  The correct
#### installation precedure is to run ./configure in the top directory.  You
#### should not edit this file; all configuration changes should be made
#### via arguments to configure.
END
cat unix/vars.mak src/vars.mak unix/unix.mak src/rules.mak >> src/Makefile
])

AC_MSG_RESULT([Installation prefix: $prefix])
